---
layout:     post
title:      译：PostgreSQL物理存储简介
date:       2021-01-18
author:     大铁憨
header-img: img/post-bg-universe.jpg
catalog: true
tags:
- Database
- PG
- PostgreSQL
- 数据库
---



我最初是为我自己写这篇文章的，我想对底层物理存储有足够的了解，以便能够理解其他可能影响数据库的概念。这篇文章可能更针对具有相似兴趣的人，我将尝试使其准确，但目的是使其更易于理解，因此我可能会忽略一些细节。

您是否应该了解Postgres如何处理物理存储？也许不是，但是如果您需要调查一些问题，了解它的工作原理可能会很有用。

PostgreSQL有一个关于该主题的章节，但是我个人不得不投入额外的资源来解决这个问题。我发现很难浏览文档的多个部分和外部资源，因此这是我尝试在单个文章中收集基本内容的尝试。在本文中，我无需费心重写所有内容，因此在某些地方我重复使用了官方文档中的段落。

在撰写本文时，Postgres的当前版本为9.5，有可能在以后的版本中使这篇文章中的信息无效。

为了说明本文的示例，我们假设我们有一个名为的数据库foo，其中包含一个名为的表bar。

## 一点术语
深入了解有关存储的文档之后，您将开始遇到一些不太常见的术语，例如关系，元组，堆，块，页面...让我尝试揭开它们的含义的神秘面纱：

atuple或anitem是行的同义词
arelation是表的同义词
afilenode是一个ID，代表对表或索引的引用。
ablock和page等于，它们表示存储表的文件的8kb段信息。
一个heap参考heap file。堆文件是可变大小的无序记录的列表。尽管使用相似的名称，但堆文件与堆数据结构不同。
CTID表示行版本在其表中的物理位置。CTID也是特殊的列，可用于每个表，但除非特别说明，否则不可见。它由页码和项目标识符的索引组成。
OID 代表对象标识符。
database cluster，我们称数据库集群为磁盘上的存储区域。数据库集群是由运行中的数据库服务器的单个实例管理的数据库的集合。
VACCUM，PostgreSQL数据库需要定期维护，即所谓的清理
如果您在这篇文章的其余部分中符合这些条件，请不要感到惊讶。在少数地方，我尽可能简化了内容。

我的数据库存储在哪里
数据库集群使用的数据文件一起存储在集群的数据目录中，通常称为PGDATA（在可用于定义它的环境变量的名称之后）。PGD​​ATA在您的操作系统或安装中可能具有不同的位置。

对于集群中的每个数据库，其中都有一个子目录PGDATA/base，该子目录以中的数据库OID命名pg_database。此子目录是数据库文件的默认位置。

如果要列出集群中每个数据库的OID，则可以运行以下查询。
```
select oid, datname from pg_database;

  oid  |   datname
-------+-------------
     1 | template1
 12398 | template0
 12403 | postgres
 17447 | foo
 ```
 
如果要查找特定数据库的OID，则可以WHERE在查询中添加一个子句：

select oid, datname from pg_database WHERE datname = 'foo';
查找数据库OID的另一种方法是使用命令行 oid2name。这是一个实用程序来检查PostgreSQL所使用的文件结构，了解如何使用它检查的详细信息资料
```
$> oid2name
All databases:
    Oid  Database Name  Tablespace
----------------------------------
  17447            foo  pg_default
  12398      template0  pg_default
      1      template1  pg_default
```
      
上面的OID在您的系统中可能完全不同，但是现在我们知道所有与数据库有关的文件foo都存储在中PGDATA/base/17447。如果您问自己表pg_database存储在哪个数据库中，那么它们不在中，PGDATA/base而是在中PGDATA/global。

现在，我们知道在文件系统中的哪里找到数据库了，所以让我们尝试找出在哪里可以找到我们的表。

表的存储位置
每个表都存储在一个单独的文件中。对于普通关系，这些文件以表或索引的文件节点号命名，可以relfilenode在表的列中找到pg_class。pg_class是存在于pg_catalog架构中的系统表。

当表超过1 GB时，它将被分为千兆字节大小的段。第一段的文件名与filenode相同；随后的段分别命名为filenode.1，filenode.2等。这种安排可以避免在文件大小受限制的平台上出现问题。

表的文件节点通常与它的OID匹配，不一定是这种情况。要查找表文件节点路径，可以在连接到数据库时运行以下查询：

select pg_relation_filepath('bar');
pg_relation_filepath
----------------------
 base/17447/27741
如果您不想要路径，而只想要文件节点，则可以使用pg_relation_filenode具有相同参数的函数。至于数据库OID，可以通过使用以下命令找到表文件节点oid2name

> oid2name -d foo -t bar

From database "foo":
  Filenode  Table Name
----------------------
     27741         bar
系统表
在上一节中，我们讨论了一些有关系统表的知识，有趣的是，有一个系统目录架构，其中包含您可能要查询以查找其他信息的表。

在创建数据库时，除了public和用户创建的模式外，每个数据库还包含一个pg_catalog模式，该模式包含系统表以及所有内置数据类型，函数和运算符。pg_catalog总是有效地成为搜索路径的一部分，因此在查询系统表时不需要使用前缀。

通过连接到数据库后psql，您可以通过以下方式列出系统表的列表：

\dt pg_catalog.*
行的存储方式
每个表都存储为固定大小（通常为8Kb）的页面数组。在一个表中，所有页面在逻辑上都是等效的，因此特定项目（行）可以存储在任何页面中。

用于存储表的结构是一个堆文件。堆文件是可变大小的无序记录的列表。堆文件的结构为页面（或块）的集合，每个页面包含项的集合。术语项是指存储在页面上的一行。

页面结构如下所示：

页面结构

它包含一些我们不打算介绍的标头，但是它们提供有关校验和，可用空间的开始，可用空间的结束，...的信息。标头后面的项目是由（偏移，长度）对组成的数组标识符，指向实际项目。

因为项目标识符直到被释放才被移动，所以即使项目本身在页面上四处移动以压缩可用空间，它的索引也可以长期用于引用项目。指向PostgreSQL的项目的指针称为CTID（ItemPointer），它由页码和项目标识符的索引组成。

项目本身存储在从未分配空间的末尾向后分配的空间中。总而言之，在页面内部，指向行的指针存储在开头，而元组（行）存储在页面的末尾。

您可以通过添加ctid选定的列来访问行的CTID ：

SELECT ctid, * from bar;
有什么限制
根据About PostgreSQL，最大列数在250到1600之间，具体取决于列类型。列类型会影响它，因为在PostgreSQL中行的最大宽度可能为8kb（一页），它们不能跨越页面。

这并不意味着列的值限制为8kb。根据类型的不同，列中可能有较大的值，因为postgreSQL具有称为TOAST的机制，可以处理该问题。仍然可以容纳多少列，这取决于所使用的数据类型的宽度。即使指向TOAST属性的指针仍需要一些字节。

超大属性存储技术
在上一节中，我们已经说过，如果某些列的类型可以使用TOAST，那么它们的大小可能超出页面的大小。让我们来概述一下TOAST。首先，TOAST代表The Oversized-Attribute Storage Technique，可能是计算机科学史上最好的缩写。

PostgreSQL使用固定的页面大小（通常为8 kB），并且不允许元组跨越多个页面。因此，不可能直接存储非常大的字段值。当试图存储超过此大小的行时，TOAST基本上将大列的数据分解为较小的“段”，并将其存储到TOAST表中。您创建的每个表都有其自己关联的（唯一）TOAST表，该表可能最终使用，也可能永远不会使用，具体取决于插入的行的大小。所有这些对用户都是透明的，并且默认情况下启用。通过将大列条目拆分为2KB字节并将它们作为块存储在TOAST表中来完成该机制。然后，它存储长度和指向通常存储该列的TOAST条目的指针。由于指针系统是如何实现的，

与更直接的方法相比，TOAST具有许多优点，例如允许行值跨越页面。仅在将结果集发送到客户端时，才会抽出TOASTed属性的大值（如果完全选中）。与没有任何离线存储（TOAST）的情况相比，表本身将更小，并且更多行适合共享缓冲区高速缓存。排序集更可能变小，这意味着排序完全在内存中完成。

在我们的示例中，barOID为的表27741将具有TOAST table pg_toast_27741。关于TOAST还有很多要说的东西，例如它还提供压缩功能，但我将其保留为必不可少的。TOAST使其对用户透明，但请记住，支持TOAST的列的限制为1GB。您可以将大量数据存储在1GB中，这对于将ARRAY类型的数据进行非规范化或以JSONB类型存储文档很有用。

自由空间地图
每个表都有一个可用空间图，该图存储有关关系中可用空间的信息。可用空间映射存储在一个文件中，该文件的名称为filenode编号加上后缀_fsm。

可用空间图中存储的值不准确。将它们舍入为页面大小的1/256的精度（32字节，默认为8kb），并且在插入和更新元组时，它们没有保持最新。某些操作会在删除所有行时更新可用空间映射，但是VACCUM将为将来的行更新可用空间映射，从而能够知道它们适合的页面。

通过运行VACUUM来更新可用空间映射，因为某行的UPDATE或DELETE不会立即删除该行的旧版本。这种方法对于获得多版本并发控制（MVCC）的好处是必不可少的：不能删除行版本，而其他交易仍然可以看到该行版本。但是最终，过时或已删除的行版本不再对任何事务有意义。然后必须占用它占用的空间，以供新行重用，以避免磁盘空间需求无限制地增长。

VACUUM的标准形式删除表中的死行版本，并标记可用于将来重用的空间。但是，它不会将空间返回给操作系统，除非在特殊情况下，表末尾的一个或多个页面变得完全空闲，并且可以获得独占表锁。这并不意味着页面内的可用空间是零散的，VACUUM会重写整个块，有效地打包剩余的行，并在页面中留下单个连续的空闲空间块。

相反，VACUUM FULL通过写入没有死角的表文件的全新版本来主动压缩表。这样可以最大程度地减少表的大小，但是会花费很长时间。在操作完成之前，表的新副本还需要额外的磁盘空间。常规VACUUM的目标是避免需要VACUUM FULL。这个想法不是要使表保持最小大小，而是要保持磁盘空间的稳态使用：每个表占用的空间等于其最小大小，加上两次清理之间要占用多少空间。

在过去，VACUUM运行时，它必须查看表中的每个元组，因为没有关于自上一个VACUUM以来尚未更新哪些页面的信息。PostgreSQL引入了可见性图，VACUUM现在能够对表数据执行部分扫描，而跳过标记为完全可见的页面。部分扫描意味着VACUUM的I / O操作更少。

您可以通过以下查询来查询表中页面可用的释放速度：

CREATE EXTENSION pg_freespace;
SELECT * FROM pg_freespace('bar'::regclass);
能见度图
每个表还具有可见性图（VM），以跟踪哪些页面仅包含已知对所有活动事务可见的元组。换句话说，要跟踪已知哪些页面没有死行。可见性映射表与表文件一起存储在单独的文件中，该文件以关系的文件节点号加上_vm后缀命名。例如，关系bar的文件节点为27741，VM存储在名为12345_vm的文件中，与主关系文件位于同一目录中。

我们在上一节中已经看到，死行是由于MVCC机制造成的。

可见性映射仅在每个堆页面中存储一位。置位意味着页面上的所有元组对于所有事务都是可见的。这意味着该页面不包含任何需要清理的元组。映射是保守的，因为我们确保只要设置了一点，我们就知道条件为真，但是如果未设置一点，则它可能为真，也可能不为真。可见性映射位仅由真空设置，但可通过页面上的任何数据修改操作清除。

索引呢
索引也存储为文件，并且存储在与表相同的目录中。索引是另外一回事了，我没有涉及它们，因为它会使这篇文章更长。即使索引也具有页面，它们也遵循不同的结构，因为它们是b树的结构（默认情况下）。

是否想使用Postgres从事具有挑战性的项目？
如果您有兴趣与Postgres合作进行一些有趣的项目，请来Opendoor加入我。我们将PostgreSQL大量用于数据处理，Web开发，数据仓库，ETL，数据科学和地理分析。我们一直在寻找热情的工程师和数据科学家加入我们的团队。请联系我们的招聘人员Ryan或通过我们的工作页面申请

## 结论

希望本文能给您足够的信息，以便您更好地了解PostgreSQL如何存储您的数据。对我来说，潜入该主题非常有用，它使其他一些概念或演讲更易于掌握，但主要是，人们必须理所当然地接受较少的行为。关于PostgreSQL存储可以说的更多，我希望我们会看到更多类似的文章，使PostgreSQL的内部部件对初学者来说可以理解。



-----------------
* 原文链接：[http://rachbelaid.com/introduction-to-postgres-physical-storage/](http://rachbelaid.com/introduction-to-postgres-physical-storage/)



------------------
如果对大铁憨的文章感兴趣，也欢迎关注大铁憨的微信公众号，微信搜索"大铁憨"，或者微信扫描下面的二维码。
![大铁憨](/img/qrcode_for_gh_datiehanhan.jpg)
