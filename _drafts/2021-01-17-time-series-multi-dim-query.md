---
layout:     post
title:      港股打新系列：什么是港股打新?
date:       2021-01-17
author:     大铁憨
header-img: img/post-bg-universe.jpg
catalog: true
tags:
- 数据库
- 多维聚合
- 时序数据库
- 降采样
---


时序数据库除了支持**高并发的写入吞吐**以及**高压缩率**，还能高效的满足如下类型的查询请求：

- 查询某条时间线一段时间内的数据点。

  例如：查询`ID=7AD45EC`的设备，在`2020-10-24T00:00:00Z ~ 2020-10-24T00:30:00Z`30分钟时间范围内，运行`风速`指标值。

- 查询多条时间线一段时间内的数据点，并按5分钟粒度降采样。

  例如：查询`ID=7AD45EC`的设备，在`2020-10-24T00:00:00Z ~ 2020-10-25T00:00:00Z`一天时间范围内，功率、风速的指标值明细，按5分钟粒度采样返回数据。

- 对某条时间线按时间范围做聚合。

  例如：查询`ID=7AD45EC`的设备，在`2020-10-24T00:00:00Z ~ 2020-10-24T00:30:00Z`时间范围内，运行功率的平均值。

- 查询多条时间线的最新点。

  例如：查询`ID=7AD45EC`的设备，最新的`功率`、`风速`。

- 按Tag做时间线聚合查询。

  例如：查询`厂商=KingWind`的设备，在`2020-10-24T00:00:00Z`的平均风速。



## 降精度

当查询的时间范围比较长，只需返回一定精度的数据时使用。



| 算子   | 描述         |
| :----- | :----------- |
| avg    | 平均值       |
| count  | 数据点数     |
| first  | 取第一个值   |
| last   | 取最后一个值 |
| min    | 最小值       |
| max    | 最大值       |
| median | 求中位数     |
| sum    | 求和         |
| zimsum | 求和         |
|        |              |
|        |              |
|        |              |
|        |              |

Fill policy 即填值。降采样先把所有时间线按照指定精度切分，并把每个降采样区间内的数据做一次运算，降采样后如果某个精度区间没有值，fill policy 可以指定在这个时间点填充具体的值。比如某条时间线降采样后的时间戳为：t+0, t+20, t+30，此时如果不指定 fill policy，只有 3 个值，如果指定了 fill policy 为 null，此时间线会有 4 个值，其中 t+10 时刻的值为 null。

Fill policy 与具体填充值的对应如下表所示。



| Fill Policy | 填充值                                   |
| :---------- | :--------------------------------------- |
| none        | 默认行为，不填值                         |
| nan         | NaN                                      |
| null        | null                                     |
| zero        | 0                                        |
| linear      | 线性填充值                               |
| previous    | 之前的一个值                             |
| near        | 邻近的一个值                             |
| after       | 之后的一个值                             |
| fixed       | 用指定的一个固定填充值（请参照下面示例） |



## 聚合

在降采样后会得到多条时间线的值，并且这些时间线的时间戳是对齐的，而聚合就是把多条时间线的值按各个对齐时刻聚合为一条时间线的结果（注意：如果只有一条时间线，则不进行聚合）。聚合时必须要求每条时间线在对应时刻都有值，如果某条时间线在某个时刻没有值，则会进行插值，插值描述如下。



**插值**

如果某条时间线某个精度区间没有值且没有使用 fill policy 进行填值，而待聚合的其他时间线中有一条时间线在此精度区间有值，则会对本时间线的这个缺值精度区间进行插值。

例如：降采样以及聚合条件为{“downsample”: “10s-avg”, “aggregator”: “sum”} ，有两条时间线需要使用 sum 聚合，按 10s-avg 做降采样后的这两条时间线有值的时间戳分别为：

line 1： t+0, t+10, t+20, t+30
line 2： t+0, t+20, t+30

第二条时间线 line 2 缺 “t+10” 这个时刻的值，那么在聚合前会对 line 2 的 “t+10” 这个时间点进行插值。插值的方法与聚合的算子有关，详见下面的算子列表。

| 算子   | 描述     | 插值方法             |
| :----- | :------- | :------------------- |
| avg    | 平均值   | 线性插值（斜率拟合） |
| count  | 数据点数 | 插 0                 |
| mimmin | 最小值   | 插最大值             |
| mimmax | 最大值   | 插最小值             |
| min    | 最小值   | 线性插值             |
| max    | 最大值   | 线性插值             |
| none   | 不做计算 | 插 0                 |
| sum    | 求和     | 线性插值             |
| zimsum | 求和     | 插 0                 |


------------------
如果对大铁憨的文章感兴趣，也欢迎关注大铁憨的微信公众号，微信搜索"大铁憨"，或者微信扫描下面的二维码。
![大铁憨](/img/qrcode_for_gh_datiehanhan.jpg)
